# 4.4 Node.js는 어떻게 node_modules에서 패키지를 찾아갈까?

## 4.4.1 모듈 해석 알고리즘

- Node.js가 모듈을 로드하고 의존성을 해결하는 일련의 과정을 모듈 해석 알고리즘이라고 지칭함
- 해당 알고리즘은 모듈의 형식에 따라 모듈 경로를 결정하는 규칙과 단계를 정의함
- 모듈을 식별할 수 있게하는 문자열을 모듈 지정자라고 하는데 대표적으로 require 함수와 import 문같은 것들이 있다.
- 모듈 지정자는 크게 세 가지 유형으로 나눌 수 있는데 1) 상대 경로 지정자, 2) 모듈 이름 지정자, 3) 절대 경로 지정자가 있다.

> 상대 경로 지정자는 현재 파일의 위치를 기준으로 경로를 지정하며 ./와 ../로 다른 디렉토리에 접근할 수 있다.
> 모듈 이름 지정자는 파일 시스템 경로가 아닌 모듈 이름만을 사용해서 참조하는 방식이다. 이때, package.json에 있는 main이나 exports 필드가 사용된다.
> 절대 경로 지정자는 파일 시스템의 최상위에서 시작하는 경로로 /로 시작한다.

## 4.4.2 모듈 이름 지정자로 모듈을 로드하는 방법

상대 경로와 절대 경로 지정자와 달리 모듈 이름 지정자의 경우에는 commonJS와 ESModule이 사용하는 방식이 다르다. 먼저 commonJS부터 알아보자.

### commonJS가 모듈을 찾는 방법

1. 내장 모듈 확인: require 함수가 요청한 모듈이 Node.js의 내장 모듈인지 확인한다.
2. 파일 해석: 명시된 파일 확장자가 있는 경우 해당 파일을 로드하며, 확장자가 생략된 경우 기본 확장자인 .js, .json, .node 순으로 파일을 탐색한다.
3. 디렉터리 해석: 모듈 지정자가 디렉터리일 경우 해당 디렉터리의 package.json 파일에서 "main" 필드를 확인하거나 index.js와 같은 기본 파일을 순차적으로 탐색해서 로드한다.
4. node_modules 폴더 탐색: 현재 디렉터리부터 상위 디렉터리로 이동하여 node_modules 폴더를 찾아 모듈을 탐색한다.

### ESModule에서 모듈을 찾는 방법

1 파일 확장자 확인: ESModule은 .js, .mjs 확장자가 있는 파일을 모듈로 인식한다. 2. 상대 및 절대 URL 해석: 생대 경료와 절대 경로 URL을 해석해 모듈의 실제 경로를 결정한다. 3. node_modules 폴더 내 package.json 확인: node_modules 폴더에 있는 package.json 파일의 'exports' 필드를 확인해 모듈 경로를 결정한다. 4. 기본 파일 인식 없음: ESModule에서는 기본 파일인 index.js 같은 파일을 자동으로 로드하지 않으므로 폴더를 모듈로 지정하려면 폴더 내의 특정 파일을 명시해야 한다. 5. 노드 모듈에서 모듈 로드: node_modules 디렉터리에서 모듈을 찾고 로드한다.

ESModule의 모듈 해석 알고리즘은 큰 틀에서 commonJS와 비슷한 부분이 많지만 세부적인 과정에서는 차이가 드러난다.

### CommonJS와 ESModules의 차이점

- CommonJS는 모듈을 로드하면서 동시에 경로를 찾지만 ESModule은 경로를 먼저 찾고 모듈을 로드한다.
- CommonJS는 파일 시스템을 기반으로 하위 경로를 찾지만 ESModule은 우선 package.json의 'exports' 필드를 경로로 해석하고 이 정보를 통해 URL 기반으로 경로를 파악한다. 이때문에 ESModule에서는 파일 확장자를 반드시 포함해야한다.
