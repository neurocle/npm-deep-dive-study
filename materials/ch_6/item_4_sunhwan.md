# 번들 도구의 신흥 강자, 비트

- 웹팩, 롤업과 같은 전통적인 번들러와는 다른 접근 방식을 위하며, 특히 개발 환경에서의 빠른 HMR(Hot Module Replacement)과 빌드 속도를 강조한다.
- 즉 더 나은 개발 생산성과 경험을 제공하는 것을 강조한다.

## 비트의 등장 배경과 소개

### 등장 배경

- 웹팩과 롤업은 JS로 작성된 번들러
- JS는 동적 타입 언어로 런타임에 타입 체크를 하고, JIT 컴파일 과정에서 추가적인 오버헤드가 있고, 단일 스레드 루프를 기반으로 한 언어이기 때문에 C, C++ 같은 저수준 언어보다 속도가 느리다.
- 웹 애플리케이션의 복잡도가 크게 증가 하면서, 수많은 파일로 얽힌 프로젝트를 빌드하는 것은 속도나 성능 측면에서 부담스러운 작업이 되었다.
- 이런 배경에서 비트는 빌드, 컴파일, HMR의 속도와 성능 이슈를 해결하는 번들러로 등장하게 되었다.
  - Vue.js 개발자 에반 유가 Vue@3.x 버전과 호환되는 웹 개발 빌드 툴을 목적으로 만듦
- 21년 2월 첫 정식 버전인 `vite@2.0.0`이 출시됐다.
  - `@vite/create-app` 비트 기반 프로젝트 스캐폴딩 툴 함께 출시
  - Vue 뿐만 아니라 리액트, 프리액트 등의 프레임워크도 지원

### 비트가 빠를 수 있었던 두 가지 이유

1. 개발 환경에서는 번들링하지 않고 ESModule 방식으로 코드를 브라우저에 제공한다.

- 파일이 변경될 때마다 모든 파일을 HMR로 재기동 하지 않고 필요한 파일만 새롭게 컴파일해 빠르게 로드할 수 있었다.
- 브라우저에서 `<script src="리소스/주소.js" type="module" >`을 이용해 달성

2. TS를 JS로 변환하기 위해 tsc 컴파일러가 아닌 esbuild를 사용한다.

- esbuild는 Go 언어 기반의 번들러로 매우 빠르다는 장점이 있다.
- 처음 비트 출시 당시에는 esbuild가 미성숙한 상황이라 TS/JSX => JS 변환 작업에만 사용하고, 그 외 다른 번들링 작업은 롤업을 사용

## 비트의 기본 개념과 특징

### 롤업과 esbuild의 공존

- 비트의 모든 내부 동작을 esbuild를 대체하면 속도가 빨라지겠지만, 아직 성숙하지 않은 툴이라 다양한 번들링 기능을 제공할 수 없었다.
- 고성능의 esbuild와 오랜 시간 개발/사용된 안정적인 롤업을 함께 사용하는 전략을 선택해 비트를 JS 번들링 생태계에 연착률 시킬 수 있었다.
- 장기적으로는 esbuild와 롤업을, 러스트 기반의 롤업 API 호환되는 롤다운으로 대체하고, 비트 내부에 러스트 코어 기능을 도입하려는 방향성이 있다.

### 의존성 사전 번들링

- 비트에서 처음 개발 모드 시작 시, 프로젝트의 선언된 의존성을 사전에 번들링 한다.

  1. CommonJS와 UMD 간의 상호호환성 확보

     - 비트는 ESModule 기반 모듈 시스템으로 운영되기 때문에 모든 의존성 모듈을 ESModule로 변환하는 작업이 필요하다.
     - 이 작업을 개발 모드에서 미리 esbuild를 통해 처리한다.
     - 개발 서버 시작 단계에서 `./node_modules/.vite/deps`에 미리 만들어 두고 필요할 때마다 호출하는 형식으로 사용한다.(캐싱 처리됨)

  2. 개발 모드에서 ESModule을 불러오는 것에 대한 최적화
     - lodash-es와 같이 내부에 많은 모듈이 있는 모듈을, 단일 모듈로 통으로 미리 번들링하는 방식으로 처리한다.
     - 실제 사용되는 모듈만 트리 셰이킹해서 번들링하지 않는 것은, 개발 모드에서는 모듈 의존성이 자주 바뀌게 되는데 이때 마다 트리 셰이킹을 하고 다시 번들링을 하면 속도가 느려지기 때문이다.

## 모던 웹 환경을 위한 도전

### "Pushing the Modern Web"

- 비트는 현대적인 모든 웹 기술을 선도한다는 개발 철학이 있다.
- 비트의 내부 의존성은 모두 최신 표준인 ESModule으로 작성된 패키지로 구성해야 한다.
- 비트 버전 6부터 비트 API를 사용하는 외부 코드도 ESModule 작성해야 한다. CommonJS까지 호환되는 코드를 유지보수하는 데 공이 많이 들기 때문.
- 비트가 생태계를

### 여러 프레임워크 지원 및 CRA의 후계자

- 다양한 라이브러리에 비트를 얹어서 사용할 수 있는 보일러플레이트(create-vite) 제공한다.(Lit, Preact, Qwik, React, Solid, 바닐라JS)
- create-vite는 기존 여러 도구를 하나의 패키지로 통합하고, 합리적인 기본 설정을 제공한 뒤, 이들 도구 간의 작은 비호환성 문제를 해결하는 CRA를 대체하고자 한다.
- 참고: CRA는 25년 부로 [deprecated](https://react.dev/blog/2025/02/14/sunsetting-create-react-app) 되었다.. 혹시 create-vite도..?

## 설정에 필요한 주요 필드

- 최상위에 `vite.config.js`(mjs, ts, mts도 지원) 생성해 구성 파일을 선언할 수 있다.

### root

- create-vite를 실행하면 `index.html` 파일이 생성되는데, 이 파일이 있는 곳이 일반적으로 root로 설정된다.
- 이는 public 폴더 내에 `index.html`이 생성되는 웹팩과는 다른 점인데, 추가적인 번들 과정 없이 `index.html` 파일이 앱의 진입점이 되게끔 하기 위함이다.
- 비트에서는 root를 최상위 디렉터리라는 개념으로도 부르는데, 이 경로에서 index.html을 비롯한 정적 파일을 제공할 수 있다. 비트 빌드 시스템 내에서 절대 경로는 이 root를 의미한다.

### base

- Next.js의 basePath와 유사한 기능으로, 값을 지정하면 `localhost:5173`이 아니라 `localhost:5173/설정값`으로 서빙된다.
- 배포하고자 하는 시스템이 최상위(root)가 아닌 경우에 유용하게 사용할 수 있다.
- 이 값은 JS, CSS, HTML과 같은 모든 정적 파일 리소스가 해당 base에 맞춰 서빙되도록 변경해준다.
- 동적으로 값을 부여하고 싶다면, `vite build --base=/help` 혹은 `import.meta.env.BASE_URL`를 사용할 수 있다.

### 비트에서의 환경변수

- 비트에서는 일반적인 프로젝트에서 Node.js에서 제공하는 `process.env`를 사용하는 것과 다르게 `import.meta`를 사용한다.
- `import.meta.env.MODE`: development, production
- `import.meta.env.BASE_URL`: App에서 제공되는 베이스 URL
- `import.meta.env.SSR`: App이 서버에서 실행 중인지 확인
- dotenv와 함께 동작해서 `.env`, `.env.local` 파일 등에서 커스텀 환경변수를 세팅해 사용할 수 있다. 이때 커스텀 환경변수는 비트 환경 내에서 `VITE_`라는 접두사를 붙여 사용할 수 있다.

### mode

- 개발 환경: development / 빌드 환경: production
- stage, test 등 커스텀 모드로 사용도 가능하다.(`process.env.NODE_ENV`로는 불가)
- dotenv와 연계해 다음과 같이 사용할 수도 있다.
  (매칭되는 env 파일이 있다면 `.env` 보다 우선해 참조한다.)
  - 개발 환경: `.env.local`
  - 빌드 환경: `.env.production`
  - 커스텀 모드: `.env.[mode]`

### define

- new webpack.DefinePlugin과 마찬가지로, 코드 내부에 있는 전역 상수로 대체될 수 있는 값을 열거해 둘 수 있다.
- 빌드하는 시점에서 해당 값으로 치환되며, JSON.stringity를 통해 직렬화하여 처리될 수 있는 값만 선언해 둬야 한다.

### plugins

- 롤업 플러그인을 이 필드에 두고 사용할 수 있다.

### publicDir과 cacheDir

- publicDir: CSS, 이미지, 폰트와 같은 정적 애셋을 제공하기 위한 디렉터리
- cacheDir: 캐시 파일을 저장하는 디렉터리(사전 번들링도 이 캐시에 담긴다.)

### build

- build.target

  - 어떤 브라우저에 맞춰 빌드할 지 지정하는 옵션
  - 기본값은 modules: ESModule의 import.meta.url과 동적 임포트를 안정적으로 지원하는 버전

- build.outDir

  - 프로젝트 번들 결과물이 생성되는 폴더
  - 기본값은 `/dist`

- build.minify

  - 코드 압축 및 경량화 여부를 결정(기본값: true)
  - 끄거나 특정 빌드 도구를 지정할 수 있다.

- build.lib

  - 라이브러리 모드로 빌드할 지 결정
  - 라이브러리 모드는 npm 레지스트리에 업로드하거나 스크립트로 삽입할 자바스크립트 패키지를 개발할 때 사용

- build.rollupOptions
  - 롤업 옵션을 커스터마이징 할 수 있는 필드
  - 롤업 구성 파일에서 사용하는 롤업 설정 관련 내용을 작성할 수 있으며, 여기에 작성된 내용은 비트가 내부적으로 사용하는 롤업 옵션과 병합된다.
