## 1. 워크스페이스

### 1. 워크스페이스란 무엇인가?

- 하나의 프로젝트를 여러 개의 자바스크립트 패키지로 분리하고, 이러한 패키지 간의 의존성을 효율적으로 관리할 필요성
- 독립적인 패키지들이 하나의 프로젝트 내에서 원활하게 작동하고 관리될 수 있도록 지원
  - 각 패키지를 별도의 저장소와 프로젝트에서 관리한다면 관리 지점이 많아져 복잡성이 증가
  - 의존 관계에 있는 패키지 간 정합성을 확인하기가 어려움
  - 공통 코드를 효율적으로 관리하기 어려움
- **yarn**과 **pnpm**이 워크스페이스 기능을 지원하면서 복잡한 모노레포 도구 대신 패키지 관리자의 워크스페이스로 전환하려는 흐름 가속화

### 2. **npm**

- 워크스페이스 설정 후 `npm install`을 실행하면 하위 패키지들이 링크로 연결되며, 각 패키지의 `node_modules` 폴더에 필요한 패키지들이 심볼릭 링크로 참조

  - 하위 패키지 간의 의존성도 자동으로 연결
  - `/package.json`
    ```json
    {
      "name": "npm-workspace",
      "workspaces": ["packages/*"]
    }
    ```
  - `/packages/utils/package.json`
    ```json
    {
      "name": "@neurocle/utils",
      "main": "index.js",
      "scripts": {
        "start": "node index.js"
      },
      "dependencies": {
        "date-fns": "^4.1.0"
      }
    }
    ```
  - `/packages/utils/index.js`

    ```js
    import { format } from "date-fns";
    import { ko } from "date-fns/locale";

    export const formatDateKo = (date) => {
      return format(date, "PPP EEE p", { locale: ko });
    };
    ```

  - File Tree

    ```bash
    .
    ├── node_modules
    │   ├── @neurocle
    │   │   └── utils -> ../../packages/utils
    │   └── date-fns
    ├── package-lock.json
    ├── package.json
    └── packages
    ```

  - `package-lock.json` 파일은 **npm** 워크스페이스 최상위 경로에 하나 생성된다.
    - 워크스페이스의 패키지는 **npm**에 올라가 있는 패키지가 아닌, `packages/utils`를 참조하는 형태로 선언된다.
  - `node_modules` 폴더도 워크스페이스 내에 하나 생성된다.
    - **Node.js**의 모듈 참조 방식 덕분에 하위 패키지들은 상위 디렉터리의 `node_modules`를 탐색하는 과정에서 필요한 의존성을 자연스럽게 찾게 된다.
  - `node_modules/@neurocle/utils`는 심볼릭 링크로 연결되어 있으며, `packages/utils`를 가리킨다.

- 워크스페이스에 새로운 패키지 추가
  1. `npm init <패키지명> -w` 또는 `npm init <패키지명> --workspace`
  2. 해당 폴더로 이동 후 직접 `package.json` 작성
- 하위 패키지의 스크립트 실행
  - `npm run start -ws` 또는 `npm run start --workspaces`
  - `npm run start --workspace=<패키지명>`

### 3. **yarn**

- 워크스페이스 개념을 처음 도입
- `yarn`에서는 패키지 간 참조 시 `workspace:` 접두사를 사용해야 한다.
- `.pnp.cjs` 파일의 `RAW_RUNTIME_STATE` 값을 보면 각 패키지의 `packageLocation` 값을 통해 `yarn`이 패키지를 찾아가는 방법을 알 수 있다.
  - 레지스트리에서 설치된 일반 패키지는 `.yarn/berry`라는 글로벌 스토어 경로를 참조한다.
  - 워크스페이스 내부에서 생성된 패키지들은 `./packages/utils`와 같이 워크스페이스 최상위 위치를 기준으로 한 실제 로컬 경로를 참조한다.
  ```js
  const RAW_RUNTIME_STATE =
    '{\
    "__info": [\
        "This file is automatically generated. Do not touch it, or risk",\
        "your modifications being lost."\
    ],\
    "dependencyTreeRoots": [\
        {\
        "name": "npm-workspace",\
        "reference": "workspace:."\
        },\
        {\
        "name": "@neurocle/utils",\
        "reference": "workspace:packages/utils"\
        }\
    ],\
    "enableTopLevelFallback": true,\
    "ignorePatternData": "(^(?:\\\\.yarn\\\\/sdks(?:\\\\/(?!\\\\.{1,2}(?:\\\\/|$))(?:(?:(?!(?:^|\\\\/)\\\\.{1,2}(?:\\\\/|$)).)*?)|$))$)",\
    "pnpZipBackend": "libzip",\
    "fallbackExclusionList": [\
        ["@neurocle/utils", ["workspace:packages/utils"]],\
        ["npm-workspace", ["workspace:."]]\
    ],\
    "fallbackPool": [\
    ],\
    "packageRegistryData": [\
        [null, [\
        [null, {\
            "packageLocation": "./",\
            "packageDependencies": [\
            ["npm-workspace", "workspace:."]\
            ],\
            "linkType": "SOFT"\
        }]\
        ]],\
        ["@neurocle/utils", [\
        ["workspace:packages/utils", {\
            "packageLocation": "./packages/utils/",\
            "packageDependencies": [\
            ["@neurocle/utils", "workspace:packages/utils"],\
            ["date-fns", "npm:4.1.0"]\
            ],\
            "linkType": "SOFT"\
        }]\
        ]],\
        ["date-fns", [\
        ["npm:4.1.0", {\
            "packageLocation": "../../../../.yarn/berry/cache/date-fns-npm-4.1.0-764604ee0f-10c0.zip/node_modules/date-fns/",\
            "packageDependencies": [\
            ["date-fns", "npm:4.1.0"]\
            ],\
            "linkType": "HARD"\
        }]\
        ]],\
        ["npm-workspace", [\
        ["workspace:.", {\
            "packageLocation": "./",\
            "packageDependencies": [\
            ["npm-workspace", "workspace:."]\
            ],\
            "linkType": "SOFT"\
        }]\
        ]]\
    ]\
    }';
  ```
- 워크스페이스 스크립트 실행에 대해 다양한 옵션을 제공한다.
  - 전체 실행, 병렬 실행 등

### 4. **pnpm**

- `pnpm-workspace.yaml` 파일을 만들어 워크스페이스를 선언한다.

  ```yaml
  packages:
    - "apps/*"
    - "configs/*"
    - "packages/*"

  catalogs:
    core:
      "next": ^15.2.3
      "react": ^19.0.0
      "react-dom": ^19.0.0
      "@types/node": ^22.0.0
      "@types/react": ^19.0.0
      "@types/react-dom": ^19.0.0
      "typescript": ^5.0.0
    style:
      "@tailwindcss/postcss": ^4.0.0
      "tailwindcss": ^4.0.0
      "motion": ^11.0.0
      "next-themes": "^0.4.4"
    util:
      "date-fns": ^4.0.0
    vercel:
      "@vercel/analytics": "^1.5.0"
      "@vercel/speed-insights": "^1.2.0"
    data-fetch:
      "ky": "^1.7.5"
  ```

- **pnpm**의 워크스페이스는 `.pnpm`이라는 글로벌 스토어를 활용해 의존성을 설치하고, `node_modules`의 실제 내용을 하드 링크로 관리한다.
- **yarn**과 마찬가지로 `workspace:` 접두사를 사용하는 워크스페이스 전용 프로토콜을 지원한다.
- 워크스페이스 스크립트 실행에 대해 다양한 옵션을 제공한다.
  - 전체 실행, 병렬 실행 등
  - 기본적으로 패키지 의존성 관계에 따라서 명령어를 실행한다. (**yarn**에서는 `-pt` 옵션을 사용)

## 2. 명령어 비교

### 1. 의존성 관리

- `install` > `add`
- `uninstall` > `remove`

### 2. 글로벌 패키지 실행

- `exec` > `dlx`

## 3. 벤치마크 테스트

### 1. Full Cold

- 완전히 새로운 머신에서 프로젝트를 처음 클론하고 설치하는 과정 (CI 환경 등)
- **pnpm** > **yarn berry** > **yarn classic** > **npm**
- **pnpm**이 가장 빠른 속도를 보인 이유는 필요한 패키지를 모두 해석하고 다운로드하는 다른 패키지 관리자와는 달리, 해당 프로젝트의 의존성이 파악되는 즉시 병렬로 다운로드하기 때문

### 2. 캐시만 존재하는 경우

- **yarn berry** > **pnpm** > **yarn classic** > **npm**
- **yarn**의 pnp는 캐시만 있다면 `.pnp.cjs`를 생성해서 경로만 지정해주면 되고, **pnpm**의 경우 해당 글로벌 캐시를 COW(Copy on Write) 처리만 해주면 되기 때문에 빠르다.

### 3. 캐시와 락 파일 모두가 존재하는 경우

- **pnpm** > **yarn berry** > **yarn classic** > **npm**
- **pnpm**과 **yarn**의 패키지 다운로드 작업이 생략된 결과

### 4. 결론

1. **npm**은 특정 상황을 제외하면 다른 패키지 관리자에 비해 현저히 느리다.
2. **yarn classic** 또한 대부분의 경우 **pnpm**이나 **yarn berry**에 비해 느리다.
   - **yarn classic**은 보안 패치 외에는 특별한 기능 개선이 이뤄지지 않고 있으므로 새로운 프로젝트를 시작할 때 선택할 이유는 거의 없다.
3. 대부분의 경우 **yarn berry**와 **pnpm**이 가장 빠른 성능을 보였으며, 그중에서도 **yarn berry**가 가장 뛰어난 성능을 나타냈다.
   - 모던 자바스크립트 프로젝트를 만드는 경우 **yarn berry**나 **pnpm**을 선택하는 것이 합리적이다.
