# bin 필드와 npx

실행 가능한(executable) 패키지를 만들고 관리하는 데 필요한 기초 지식 확립

## CLI 패키지

- 명령줄 인터페이스(Command Line Interface)를 통해 사용되는 소프트웨어 패키지
- 터미널과 같은 명령 프롬프르에서 패키지 명령어 입력해 실행 가능
- 다양한 옵션과 인자를 통해 동작을 유연하게 조정 가능

### 대표적인 JS 생태계 CLI 도구

- create-react-app, Vue CLI, ESLint, Prettier, Webpack, Rollup...

### CLI 패키지 개발의 이점

- 반복 작업의 자동화: 빌드, 배포, 테스트 등 반복적인 작업을 자동화 => 생산성 향상
- 프로젝트 구조화: 초기 설정과 구조화를 표준화해 일관성 있는 개발 환경을 구축 => 코드 품질과 유지보수성 향상
- 사용자 친화적인 인터페이스 제공: 복잡한 작업을 쉽게 수행할 수 있게 함 => 생산성 향상

## bin 필드

- 패키지에서 실행 가능한 스크립트 또는 바이너리 파일을 지정하는 역할
- 전역 또는 로컬로 실행 가능한 명령어를 설정 가능
- 패키지 설치 시 자동으로 사용자 환경에 추가되므로 패키지 외부에서도 특정 스크립트를 실행 파일처럼 사용 가능

### bin 필드 설정하기

```js
// neurocle-cli-package/bin/cli.js

#!/usr/bin/env node

console.log('cli 실행')
```

```json
{
  "name": "neurocle-cli-package",
  "bin": "./bin/cli.js",
  "files": ["bin/", "index.js"]
}
```

- bin 필드에 실행할 스크립트의 상대 경로를 지정하면 패키지 이름 자체가 실행 가능한 명령어로 사용된다.
- 필드를 객체로 정의해 여러 명령어를 설정할 수 있다. 이 경우 객체의 key가 명령어, value가 실행할 스크립트의 경로를 의미한다.

```bash
$ npx neurocle-cli-package # ".bin/cli.js" 실행
cli 실행
```

- 실행 가능한 파일의 조건
  1. 실행 가능 권한 설정
     - 스크립트 파일에 실행 가능 권한을 부여해야 한다.
     - 유닉스 계열 시스템에서는 chmod 명령어를 통해 파일에 실행 권한을 부여할 수 있다.
     - 패키지 배포 시에는 npm에서 자동으로 처리되지만, 로컬에서 테스트할 때는 개발자의 직접 설정이 필요하다.
       `chmod +x ./bin/cli.js`
  2. 셔뱅 라인 추가
     - Node.js 스크립트로 실행할 파일임을 나타내기 위해 파일 첫 줄에 `#!/usr/bin/env node`와 같은 셔뱅 라인을 추가해야 한다.

### 패키지의 설치와 실행

1. 패키지를 설치하면, Node.js bin 필드에 정의된 키를 명령어로 등록(node_modules/.bin 폴더에 심볼릭 링크를 생성하는 것)
2. 특정 패키지가 다른 패키지의 의존성으로 설치될 때 아래 두 가지 방법으로 실행 가능
   - npx 혹은 npm exec으로 직접 접근 - 터미널에서 직접 실행
   - npm run-script로 호출 - package.json scripts 필드에서 정의해 사용
3. 패키지 실행 시 Node.js의 PATH 환경변수에서 검색

   - 로컬 또는 전역 node_modules/.bin 폴더에 해당 패키지에 대한 심볼릭 링크가 있는지 탐색
   - 이때 링크가 존재하면 스크립트 파일의 셔뱅 라인을 통해 Node.js 해석기 호출 및 스크립트 파일 실행

## npx

- Node.js 환경에서 npm 패키지를 손쉽게 실행하고 관리할 수 있도록 돕는 명령어 실행 도구
- npm@5.2.0부터 npm 설치 시 자동 설치
- 패키지 별도 설치 없이도 npm 레지스트리에서 패키지를 실행할 수 있는 유용한 기능 제공

### npx의 주요 기능

1. 로컬 패키지 실행
   - `npx prettier`
2. 전역 설치 없이 실행

   - `npx create-react-app my-app`

3. 특정 버전의 패키지 실행
   - `npx create-react-app@4.0.3 my-app`
4. 스크립트 실행
   - `-c` 옵셥을 사용해 임시 스크립트 실행 가능. 아직 npm에 등록되지 않은 스크립트를 작성해 빠르게 테스트하거나 단순 작업을 임시 실행하는 데 유용

### npx에서 사용할 수 있는 옵션

- `--package(-p)`: 특정 패키지를 지정해 명령어 실행할 수 있는 옵션. 패키지 설치 없이도 특정 버전의 실행 파일을 사용할 때 유용
  - `npx -p @package/foo foo`
- `-c`: 셸 환경에서 문자열 실행 가능. 여러 명령을 순차적으로 실행하거나 복잡한 구문의 명령을 실행하는 데 유용
  - `npx -c 'echo "Hello, World!"`
- `--yes`와 `--no`: 패키지 설치 여부에 따른 실행 여부를 명시적으로 관리

### npx는 어떻게 패키지를 찾아서 실행할까?

1. 입력 명령어 파싱

   - 실행할 패키지의 이름과 버전 결정

2. 로컬 패키지 탐색

   - 현재 작업 중인 디렉터리의 node_modules/.bin 폴더에서 패키지 탐색

3. 캐시 확인

   - 로컬 패키지가 없는 경우 이전에 실행한 패키지를 저장한 npm 캐시 폴더에서 패키지 탐색

4. 레지스트리에서 패키지 검색
   - npm 레지스트리에서 패키지 검색해 최신 버전을 가져옴
5. 패키지 설치
   - 임시 디렉터리에 다운로드해 설치. 패키지는 전역 설치되지 않고 일시 저장됨
6. 패키지 실행
   - 패키지 준비되면 npx는 실행 파일을 찾아 실행. 이때 package.json bin 필드 참조
7. 패키지 정리
   - 실행이 완료되면 설치된 패키지 정리

### npx와 npm exec의 차이점

- npx 사용 시에는 모든 플래그와 옵션을 명령어 실행하기 전에 설정해야 한다.(명령어와 그에 따른 옵션을 정확히 순서대로 입력해야 한다.)

  - `npx --package @package/foo foo`
  - `npx foo --package @package/foo`
    => 이때 foo라는 패키지를 바로 참조 시도해서 오류남

- npm exec의 경우, 옵션을 명령어 이후에 입력해도 npx exec의 인자로 인식한다.

  - `npm exec foo --package @package/foo`
    => 이때 --package를 npm exec의 인자로 인식해 정상 동작함

- 이때 --package 옵션을 foo의 옵션으로 활용하고자 한다면, 이중 하이픈 플래그를 활용할 수 있다.

  - `npm exec -- foo --package @package/foo`

- 이중 하이픈 플래그는 주로 명령어나 npm 스크립트를 실행할 때 옵션을 명확히 구분 짓는 역할을 한다.
